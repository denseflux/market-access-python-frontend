{% extends "reports/barrier_wizard_step.html" %}

{% block page_title %} Report A Barrier - Wizard Framework - Sectors Affected{% endblock %}

{% block fields %}
    <div class="govuk-form-group">
        <fieldset class="govuk-fieldset">
            <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
                <h1 class="govuk-fieldset__heading">
                    Sectors affected
                </h1>
            </legend>

            {% form_error_banner form %}

                <!-- Main Sector-->
                <div id="{{ form.main_sector.name }}" class="govuk-form-group {% if form.main_sector.errors %} govuk-form-group--error{% endif %}">
                    <label class="govuk-label govuk-label--s" for="{{ form.main_sector.id_for_label }}">
                        {{ form.main_sector.label }}
                    </label>

                    {% form_field_error form "main_sector" %}

                    <select class="govuk-select govuk-!-width-full{% if form.sector.errors %} govuk-select--error{% endif %}" id="main_sector_select" name="barrier-sectors-affected-main_sector"{% if form.main_sector.errors %} aria-describedby="main_sector-error"{% endif %}>
                        {% for id, name in sectors_list %}
                        <option value="{{ id }}">{{ name }}</option>
                        {% endfor %}

                    </select>

                </div>


                <!-- Add Other Sector-->
                <div id="{{ form.sectors.name }}_edit" class="govuk-form-group selection-list {% if form.sectors.errors %} govuk-form-group--error{% endif %}">
                    <label class="govuk-label govuk-label--s" for="{{ form.sectors.id_for_label }}">
                        Add sector
                    </label>

                    {% form_field_error form "sectors" %}

                    <select class="govuk-select govuk-!-width-full  {% if form.sectors.errors %} govuk-select--error{% endif %}" id="sectors_select" name="sector"{% if form.sector.errors %} aria-describedby="sectors-error"{% endif %}>
                        {% for id, name in sectors_list %}
                        <option value="{{ id }}">{{ name }}</option>
                        {% endfor %}

                    </select>

                    <a href="#" onclick="append_sector('id_barrier-sectors-affected-sectors', 'sectors_select', 'sectors_list_display')" class="govuk-button govuk-!-margin-top-5 "> Add sector</a>
                </div>

                <!-- Display Other Sector-->

                <div class="selection-list restrict-width" id="{{ form.sectors.name }}_display" >
                    <label class="govuk-label govuk-label--s" for="{{form.sectors.id_for_label }}">
                        {{ form.sectors.label }}
                    </label>

                    <span id="description-hint" class="govuk-hint">
                        {{ form.sectors.help_text }}
                    </span>

                    {% form_field_error form "sectors" %}

                    <ul class="selection-list__list" id="sectors_list_display">

                            <li class="selection-list__list__item">
                                {{ item.name }}
                            </li>

                    </ul>
                    <a href="#" onclick="toggle_mode('edit')" class="govuk-button"> Add sector</a>
                </div>


                <!-- Hidden formtools fields -->
                {{ form.sectors.as_hidden }}



        </fieldset>
    </div>
{% endblock %}

{% block body_script %}
<script>

    function append_sector(fieldname, select, display_list) {
        let sector_select = document.getElementById(select)
        let sector = sector_select.value;
        let sector_name = sector_select.options[sector_select.selectedIndex].text;
        let current_sector_list = document.getElementById(fieldname)
        console.log("current sector values :", current_sector_list.value)
        if (!!current_sector_list.value ){
            const new_list= JSON.parse(current_sector_list.value);
            console.log( new_list.length, " items so far")
            console.log("entries found adding, ", sector)
            if ( new_list.includes(sector)){
                // Already selected do nothing
                console.log("Entry Already present")
            } else {
                new_list.push(sector);
                current_sector_list.value= JSON.stringify(new_list)
            }
        } else {
            const new_list =[];
            console.log("empty sector ");
            new_list.push(sector);
            console.log("empty sector : ", new_list);
            current_sector_list.value = JSON.stringify(new_list);
        }
        update_sector_display()
        toggle_mode('display')

    }

    function update_sector_display(){
        const sector_list = document.getElementById("sectors_select")
        const current_selected_list = document.getElementById("id_barrier-sectors-affected-sectors")
        //const selected_list = JSON.parse(current_selected_list.value);
        const display_list = document.getElementById("sectors_list_display")
        if (current_selected_list.value == ""){
            const selected_list = current_selected_list.value;
        } else {
            const selected_list = JSON.parse(current_selected_list.value);
            console.log("change detected", selected_list);
            display_list.innerHTML = "";
            for (let i = 0; i < selected_list.length; i++) {
                console.log("update display : ", selected_list[i]);
                for (let x = 0; x < sector_list.length; x++) {
                    let option = sector_list.options[x];
                    if (option.value == selected_list[i]) {
                        let sector_entry = document.createElement("li");
                        sector_entry.classList.add("selection-list__list__item");
                        sector_entry.appendChild(document.createTextNode(option.text));
                        let remove_link = document.createElement("a");
                        let remove_link_text = document.createTextNode("remove");
                        remove_link.setAttribute("href", "#");
                        remove_link.appendChild(remove_link_text);
                        remove_link.classList.add("selection-list__list__item__remove-form");
                        sector_entry.appendChild(remove_link);
                        display_list.appendChild(sector_entry);
                        console.log("display text :", option.text);
                    }
                }

            }
        }

    }

    function toggle_mode(mode){
        const edit_div = document.getElementById("sectors_edit")
        const display_div = document.getElementById("sectors_display")
        console.log("edit div : ",  window.getComputedStyle(edit_div).display)
        if (mode === 'edit'){
            edit_div.style.display = 'block';
            display_div.style.display = 'none';
        } else {
            console.log("switch to display mode")
            display_div.style.display = 'block';
            edit_div.style.display = 'none';
        }
        if ( window.getComputedStyle(edit_div).display === 'block'){
            console.log("hide display ");
            display_div.style.display = 'none';
        } else if (( window.getComputedStyle(display_div).display === 'block')) {
            console.log("hide edit ");
            edit_div.style.display = 'none';

        }
    }

    document.addEventListener('readystatechange', function(event) {
        if (document.readyState === "complete") {
            update_sector_display();
            toggle_mode('display');

        }
    });
</script>
{% endblock %}
